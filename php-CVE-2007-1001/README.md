# [CVE-2007-1001](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2007-1001)
- behavior: segmentation fault
- description: read a crafted wbmp image file whose width\*height > 2^32 
- sketch: 

    - `php_gd_readwbmp` at ext/gd/libgd/wbmp.c:179

        `if ((wbmp->bitmap = (int *) safe_emalloc(wbmp->width * wbmp->height, sizeof(int), 0)) == NULL)`

        *test.wbmp* has a width of `0x40000001` and a height of `0x4`. Therefore, `wbmp->width = 0x40000001`, `wbmp->height = 0x4`. `wbmp->bitmap` is supposed to be allocated the address space to store the image, the size of which is `wbmp->width * wbmp->height` of 4 byte, each representing a pixel. Though due to integer overflow, `wbmp->bitmap` is only allocated 4 \* 4 byte here.

        ```C
        pos = 0;
        for (row = 0; row < wbmp->height; row++) {
            for (col = 0; col < wbmp->width;) {
                byte = getin (in);

                for (pel = 7; pel >=0; pel--) {
                    if (col++ < wbmp->width) {
                        if (byte & 1 << pel) {
                            wbmp->bitmap[pos] = WBMP_WHITE;
                        }
                        else {
                            wbmp->bitmap[pos] = WBMP_BLACK;
                        }
                        pos++;
                    }
                }
            }
        }
        ```
       
        When `pos = 746` and `pel = 5`, `wbmp->bitmap[pos] = WBMP_BLACK`, in which address `0x555555e36658` to `0x555555e3665b` is filled with 0.(heap overflow)

        When the current iteration of `for (pel = 7; pel >=0; pel--a)` finished, `pos = 752`,

        `byte = getin (in);`

        - `php_gd_gd_getin` at ext/gd/libgd/gd_wbmp.c:81

            `return (gdGetC((gdIOCtx *) in));`

            - `php_gd_gdGetC` at ext/gd/libgd/gd_io.c:73

                ` return ((ctx->getC) (ctx));`

                `ctx`, *i.e.* infile `in` is `0x555555e36658`, the address space is just malformed. `ctx->getC = 0x0`, segmentation fault.

- patch: [Check integer overflow for width \* height](http://git.php.net/?p=php-src.git;a=commit;h=37ad5f77df0ad2483e717ca32c6f4abf3b94c3c9)
